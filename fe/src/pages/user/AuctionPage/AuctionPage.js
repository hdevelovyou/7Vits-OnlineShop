// AuctionPage.js
import React, { useState, useEffect } from 'react';
import { useNavigate } from 'react-router-dom';
import socket from '../../../components/socket'; // ƒê∆∞·ªùng d·∫´n t·ªõi socket.js ƒë√£ s·ª≠a
import axios from 'axios';
import './style.scss'; // Import SCSS file

export default function AuctionPage({ auctionId }) {
  const navigate = useNavigate();
  const [auction, setAuction] = useState(null);
  const [bidAmount, setBidAmount] = useState('');
  const [timeLeft, setTimeLeft] = useState(0);
  const userId = localStorage.getItem('userId');

  useEffect(() => {
    // 1) Join room ngay khi component mount ho·∫∑c auctionId thay ƒë·ªïi
    //    (Kh√¥ng c·∫ßn g·ªçi socket.connect() v√¨ ch√∫ng ta ƒë√£ ƒë·ªÉ autoConnect = true)


    // 2) ƒêƒÉng k√Ω listener bid_updated **·ªü ngay ƒë·∫ßu** (ƒë·ªÉ kh√¥ng b·ªè l·ª° event)
    const handleBidUpdated = (data) => {
      console.log('[Client] Received bid_updated:', data);
      // data = { auctionId, currentBid, bidderId }

      // **So s√°nh ki·ªÉu NUMBER/STRING sao cho lu√¥n kh·ªõp**:
      // Ch√∫ng ta convert c·∫£ hai v·ªÅ String ƒë·ªÉ so s√°nh, ho·∫∑c d√πng == thay cho ===
      if (data.auctionId.toString() === auctionId.toString()) {
        setAuction(prev => {
          if (!prev) return prev;
          return { ...prev, current_bid: data.currentBid };
        });
      }
    };
    const handleAuctionClosed = async (data) => {
      console.log('[Client] auction_closed:', data);
      if (data.winner) {
        alert(`üéâ Phi√™n ƒë·∫•u gi√° k·∫øt th√∫c!\nNg∆∞·ªùi chi·∫øn th·∫Øng: ID ${data.winner.id}\nGi√°: ${data.winner.amount.toLocaleString()} VND`);
      }

      if (data.winner.id.toString() === userId.toString()) {
        alert(
          `üéâ Phi√™n ƒë·∫•u gi√° k·∫øt th√∫c!\n` +
          `B·∫°n ch√≠nh l√† ng∆∞·ªùi chi·∫øn th·∫Øng v·ªõi gi√°: ${data.winner.amount.toLocaleString()} VND.`
        );
        const productId = data.productId;
        if (!productId) {
          alert('‚ùå Kh√¥ng t√¨m th·∫•y th√¥ng tin s·∫£n ph·∫©m ƒë·ªÉ t·∫°o ƒë∆°n h√†ng.');
          return;
        }
        try {
          const payload = {
            items: [{ productId}], // t√πy c·∫•u tr√∫c DB
            totalAmount: parseFloat(data.winner.amount),
          
            
          };
          const res = await axios.post(
            `${process.env.REACT_APP_API_URL}/api/orders/create`,
            payload,
            { withCredentials: true }
          );
          alert('‚úÖ ƒê∆°n h√†ng c·ªßa b·∫°n ƒë√£ ƒë∆∞·ª£c t·∫°o th√†nh c√¥ng!');
          // Chuy·ªÉn qua trang danh s√°ch ƒë∆°n h√†ng (t√πy b·∫°n ƒë·∫∑t route)
          navigate('/user/purchase-history');
        } catch (err) {
          console.error('Error creating order:', err);
          alert(err.response?.data?.message || 'T·∫°o ƒë∆°n h√†ng th·∫•t b·∫°i.');
        }
      }
      else {
        alert('‚õî Phi√™n ƒë·∫•u gi√° k·∫øt th√∫c nh∆∞ng kh√¥ng c√≥ ng∆∞·ªùi tham gia.');
      }

      setAuction(prev => ({
        ...prev,
        status: 'finished'
      }));
    };
    // 3) (Optional) L·∫Øng nghe event bid_failed ƒë·ªÉ hi·ªÉn th·ªã alert khi bid l·ªói
    const handleBidFailed = (err) => {
      console.log('[Client] Received bid_failed:', err);
      if (err && err.message) {
        alert(err.message);
      }
    };
    socket.on('bid_updated', handleBidUpdated);
    socket.on('bid_failed', handleBidFailed);
    socket.on('auction_closed', handleAuctionClosed);
    socket.emit('join_auction', auctionId);
    console.log(`[Client] emit join_auction: ${auctionId}`);
    // 4) Fetch chi ti·∫øt auction ban ƒë·∫ßu (ƒë·ªÉ hi·ªÉn th·ªã v√† t√≠nh timeLeft)
    axios.get(`${process.env.REACT_APP_API_URL}/api/auctions/${auctionId}`, {
      withCredentials: true   // üî• B·∫ÆT BU·ªòC ƒë·ªÉ g·ª≠i cookie session
    })
      .then(res => {
        setAuction(res.data);
        const end = new Date(res.data.end_time).getTime();
        setTimeLeft(end - Date.now());
      })
      .catch(err => {
        console.error('[Client] L·ªói khi GET auction:', err);
      });

    // 5) Cleanup khi component unmount ho·∫∑c auctionId thay ƒë·ªïi
    return () => {
      console.log(`[Client] emit leave_auction: ${auctionId}`);
      socket.emit('leave_auction', auctionId);
      socket.off('auction_closed', handleAuctionClosed);
      socket.off('bid_updated', handleBidUpdated);
      socket.off('bid_failed', handleBidFailed);
    };
  }, [auctionId]);

  // ƒê·∫øm ng∆∞·ª£c th·ªùi gian, c·ª© m·ªói gi√¢y setTimeLeft l·∫°i
  useEffect(() => {
    if (!auction) return;

    const timer = setInterval(() => {
      setTimeLeft(prev => {
        if (prev <= 1000) {
          clearInterval(timer);
          return 0;
        }
        return prev - 1000;
      });
    }, 1000);
    return () => clearInterval(timer);
  }, [auction]);

  // H√†m x·ª≠ l√Ω khi ng∆∞·ªùi d√πng b·∫•m n√∫t "ƒê·∫∑t gi√°"
  const handleBid = () => {
    const amount = parseFloat(bidAmount);
    if (isNaN(amount)) {
      alert('Vui l√≤ng nh·∫≠p m·ªôt s·ªë h·ª£p l·ªá.');
      return;
    }
    if (!auction) {
      alert('ƒêang t·∫£i d·ªØ li·ªáu, vui l√≤ng ch·ªù.');
      return;
    }
    if (amount <= auction.current_bid) {
      alert(`Gi√° ph·∫£i cao h∆°n gi√° hi·ªán t·∫°i (${auction.current_bid.toLocaleString()} VND).`);
      return;
    }

    // Emit s·ª± ki·ªán place_bid l√™n server
    console.log('[Client] emit place_bid:', {
      auctionId: auction.id,
      bidderId: userId,
      amount
    });
    socket.emit('place_bid', {
      auctionId: auction.id,
      bidderId: userId,
      amount: amount,
    });

    // Reset input
    setBidAmount('');
  };

  if (!auction) {
    return (
      <div className="auction-container">
        <div className="loading">ƒêang t·∫£i phi√™n ƒë·∫•u gi√°...</div>
      </div>
    );
  }

  // T√≠nh minutes v√† seconds t·ª´ timeLeft (ms)
  const minutes = Math.floor(timeLeft / 60000);
  const seconds = Math.floor((timeLeft % 60000) / 1000);

  // Determine auction status for styling
  const getAuctionStatusClass = () => {
    if (timeLeft <= 0) {
      return auction.status === 'finished' ? 'finished' : 'ended';
    }
    return '';
  };

  // T√≠nh to√°n th·ªùi gian c√≤n l·∫°i theo ng√†y, gi·ªù, ph√∫t, gi√¢y
  const calculateTimeRemaining = () => {
    if (timeLeft <= 0) return { days: 0, hours: 0, minutes: 0, seconds: 0 };

    const days = Math.floor(timeLeft / (1000 * 60 * 60 * 24));
    const hours = Math.floor((timeLeft % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
    const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
    const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);

    return { days, hours, minutes, seconds };
  };

  const { days, hours, minutes: mins, seconds: secs } = calculateTimeRemaining();

  // Format time display
  const formatTimeDisplay = () => {
    const parts = [];
    if (days > 0) parts.push(`${days} ng√†y`);
    if (hours > 0) parts.push(`${hours} gi·ªù`);
    if (mins > 0) parts.push(`${mins} ph√∫t`);
    if (secs > 0 || parts.length === 0) parts.push(`${secs} gi√¢y`);
    
    return parts.join(' ');
  };

  // Render individual time units for better styling
  const renderTimeUnits = () => {
    const units = [];
    
    if (days > 0) {
      units.push(
        <span key="days" className="time-unit">
          <span className="time-number">{days}</span>
          <span className="time-label">ng√†y</span>
        </span>
      );
    }
    
    if (hours > 0) {
      units.push(
        <span key="hours" className="time-unit">
          <span className="time-number">{hours}</span>
          <span className="time-label">gi·ªù</span>
        </span>
      );
    }
    
    if (mins > 0) {
      units.push(
        <span key="minutes" className="time-unit">
          <span className="time-number">{mins}</span>
          <span className="time-label">ph√∫t</span>
        </span>
      );
    }
    
    if (secs > 0 || units.length === 0) {
      units.push(
        <span key="seconds" className="time-unit">
          <span className="time-number">{secs}</span>
          <span className="time-label">gi√¢y</span>
        </span>
      );
    }
    
    return units;
  };

  // Determine if time is urgent (less than 1 hour)
  const isUrgent = timeLeft > 0 && timeLeft < 3600000; // 1 hour in milliseconds

  return (
    <div className="auction-page">
      <div className="auction-container">
        {auction.image_url && (
          <div className="auction-image">
            <img src={auction.image_url} alt="·∫¢nh s·∫£n ph·∫©m" />
          </div>
        )}
  
        <h2>
          <span className="emoji">üõí</span>
          {auction.item_name}
        </h2>
        
        <p>{auction.description}</p>
        
        {auction.game_key && (
          <p><strong>üéÆ Key game:</strong> {auction.game_key}</p>
        )}
        
        <p>
          <strong>Gi√° hi·ªán t·∫°i:</strong>{' '}
          <span className="current-bid">
            {auction.current_bid.toLocaleString()} VND
          </span>
        </p>
        
        <p>
          <strong>‚è∞ C√≤n l·∫°i:</strong>{' '}
          <span className={`time-remaining ${isUrgent ? 'urgent' : ''}`}>
            {renderTimeUnits()}
          </span>
        </p>
  
        {timeLeft > 0 ? (
          <div className="bid-section">
            <input
              type="number"
              placeholder="Nh·∫≠p gi√° ƒë·∫•u (VND)"
              value={bidAmount}
              onChange={e => setBidAmount(e.target.value)}
              min={auction.current_bid + 1}
            />
            <button onClick={handleBid}>
              ƒê·∫∑t gi√°
            </button>
          </div>
        ) : (
          <div className={`auction-status ${getAuctionStatusClass()}`}>
            {auction.status === 'finished' ? (
              <>
                üéâ Phi√™n ƒë·∫•u gi√° ƒë√£ k·∫øt th√∫c! <br />
                üèÜ Ng∆∞·ªùi chi·∫øn th·∫Øng: {auction.winner_name ? auction.winner_name : 'Kh√¥ng c√≥ ai ƒë·∫•u gi√°'}
              </>
            ) : (
              <>‚õî Phi√™n ƒë·∫•u gi√° ƒë√£ k·∫øt th√∫c</>
            )}
          </div>
        )}
      </div>
    </div>
  );
}
